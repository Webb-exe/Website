---
// Navigation.astro - Fixed navigation with view transitions
---

<nav
  id="main-nav"
  class="fixed top-0 left-0 right-0 z-1000 section-wrapper py-4 sm:py-5"
>
  <div class="section-content flex justify-between items-center">
    <a href="/" class="no-underline" data-transition-name="nav-logo">
      <img src="/logo-icon.svg" alt="359 Webb.exe Logo" class="w-12 h-12" />
    </a>

    <!-- Desktop Links -->
    <div class="desktop-links hidden md:flex items-center gap-6 lg:gap-10" data-transition-name="nav-links">
      <a
        href="#about"
        class="flex items-center text-gray-400 no-underline text-sm uppercase tracking-widest hover:text-white transition-colors"
        >About</a
      >
      <a
        href="/team"
        class="flex items-center text-gray-400 no-underline text-sm uppercase tracking-widest hover:text-white transition-colors"
        >Team</a
      >
      <a
        href="#contact"
        class="flex items-center text-gray-400 no-underline text-sm uppercase tracking-widest hover:text-white transition-colors"
        >Contact</a
      >
    </div>

    <!-- Mobile Menu Button -->
    <button
      id="mobile-menu-btn"
      class="md:hidden flex flex-col justify-center items-center w-10 h-10 gap-1.5 rounded-lg hover:bg-white/5 transition-colors"
      aria-label="Toggle menu"
      aria-expanded="false"
      data-transition-name="mobile-menu-btn"
    >
      <span class="menu-line w-5 h-0.5 bg-gray-400 rounded-full origin-center"></span>
      <span class="menu-line w-5 h-0.5 bg-gray-400 rounded-full origin-center"></span>
      <span class="menu-line w-5 h-0.5 bg-gray-400 rounded-full origin-center"></span>
    </button>
  </div>

  <!-- Mobile Menu Dropdown -->
  <div id="mobile-menu" class="md:hidden overflow-hidden h-0 opacity-0">
    <div class="flex flex-col gap-1 pt-4 pb-2">
      <a
        href="#about"
        class="mobile-menu-link text-gray-400 no-underline text-sm uppercase tracking-widest hover:text-white hover:bg-white/5 transition-colors px-4 py-3 rounded-lg"
        >About</a
      >
      <a
        href="/team"
        class="mobile-menu-link text-gray-400 no-underline text-sm uppercase tracking-widest hover:text-white hover:bg-white/5 transition-colors px-4 py-3 rounded-lg"
        >Team</a
      >
      <a
        href="#contact"
        class="mobile-menu-link text-gray-400 no-underline text-sm uppercase tracking-widest hover:text-white hover:bg-white/5 transition-colors px-4 py-3 rounded-lg"
        >Contact</a
      >
    </div>
  </div>
</nav>

<style>
  #main-nav {
    transition:
      background-color 0.3s ease,
      backdrop-filter 0.3s ease,
      box-shadow 0.3s ease;
    background-color: rgba(10, 10, 10, 0);
    backdrop-filter: blur(0px);
  }

  #main-nav.nav-scrolled {
    background-color: rgba(10, 10, 10, 0.9);
    backdrop-filter: blur(20px);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
  }

  #main-nav.nav-menu-open {
    background-color: rgba(10, 10, 10, 0.9);
    backdrop-filter: blur(20px);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
  }

  .menu-line {
    transition:
      transform 0.05s ease,
      opacity 0.3s ease;
  }

  .desktop-links a {
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  import { requestScrollTriggerRefresh } from '../../lib/requestScrollTriggerRefresh';

  gsap.registerPlugin(ScrollTrigger);

  let nav: HTMLElement | null = null;
  let logo: HTMLElement | null = null;
  let links: HTMLElement | null = null;
  let mobileMenuBtn: HTMLElement | null = null;
  let mobileMenu: HTMLElement | null = null;
  let isMenuOpen = false;
  let navTween: gsap.core.Tween | null = null;
  let lastScrollY = 0;
  let scrollDirection: "up" | "down" = "up";

  function initNavigation() {
    nav = document.getElementById('main-nav');
    logo = document.querySelector('#main-nav a[href="/"]');
    links = document.querySelector('.desktop-links');
    mobileMenuBtn = document.getElementById('mobile-menu-btn');
    mobileMenu = document.getElementById('mobile-menu');

    if (!nav) return;

    // Set initial position
    gsap.set(nav, { y: 0 });

    // Animate nav in on load
    if (logo) {
      gsap.fromTo(
        logo,
        { opacity: 0, x: -30 },
        { opacity: 1, x: 0, duration: 0.4, ease: "power3.out" }
      );
    }

    if (links) {
      const linkElements = links.querySelectorAll("a");
      gsap.fromTo(
        linkElements,
        { opacity: 0, y: -20 },
        {
          opacity: 1,
          y: 0,
          duration: 0.25,
          stagger: 0.05,
          ease: "power2.out",
          delay: 0.15,
        }
      );
    }

    // Mobile menu button animation
    if (mobileMenuBtn) {
      gsap.fromTo(
        mobileMenuBtn,
        { opacity: 0, scale: 0.8 },
        {
          opacity: 1,
          scale: 1,
          duration: 0.25,
          ease: "back.out(1.7)",
          delay: 0.15,
        }
      );
    }

    // Handle scroll events
    if (typeof window !== "undefined") {
      window.addEventListener("scroll", handleScroll, { passive: true });
      lastScrollY = window.scrollY;
      updateNavBackground();
    }

    // Mobile menu toggle
    if (mobileMenuBtn && mobileMenuBtn instanceof HTMLElement) {
      mobileMenuBtn.addEventListener('click', toggleMenu);
    }

    // Close menu when clicking links
    const menuLinks = document.querySelectorAll('.mobile-menu-link');
    menuLinks.forEach(link => {
      if (link instanceof HTMLElement) {
        link.addEventListener('click', closeMenu);
      }
    });

    requestScrollTriggerRefresh();
  }

  function toggleMenu() {
    if (!nav || !mobileMenu || !mobileMenuBtn) return;
    
    isMenuOpen = !isMenuOpen;
    if (isMenuOpen) {
      // Add dark background when menu opens and ensure nav is visible
      nav.classList.add("nav-scrolled", "nav-menu-open");
      if (navTween) navTween.kill();
      gsap.to(nav, { y: 0, duration: 0.05, ease: "power1.inOut" });
      if (mobileMenu) {
        gsap.to(mobileMenu, {
          height: "auto",
          opacity: 1,
          duration: 0.05,
          ease: "power1.out",
        });
      }
      const menuLines = mobileMenuBtn?.querySelectorAll(".menu-line");
      if (menuLines) {
        gsap.to(menuLines, {
          rotation: (i: number) => (i === 0 ? 45 : i === 2 ? -45 : 0),
          y: (i: number) => (i === 0 ? 6 : i === 2 ? -6 : 0),
          opacity: (i: number) => (i === 1 ? 0 : 1),
          duration: 0.05,
        });
      }
      if (mobileMenuBtn && mobileMenuBtn instanceof HTMLElement) {
        mobileMenuBtn.setAttribute('aria-expanded', 'true');
      }
    } else {
      // Remove menu-open class, but keep nav-scrolled if scrolled
      nav.classList.remove("nav-menu-open");
      updateNavBackground();
      if (mobileMenu) {
        gsap.to(mobileMenu, {
          height: 0,
          opacity: 0,
          duration: 0.05,
          ease: "power1.in",
        });
      }
      const menuLines = mobileMenuBtn?.querySelectorAll(".menu-line");
      if (menuLines) {
        gsap.to(menuLines, {
          rotation: 0,
          y: 0,
          opacity: 1,
          duration: 0.05,
        });
      }
      if (mobileMenuBtn && mobileMenuBtn instanceof HTMLElement) {
        mobileMenuBtn.setAttribute('aria-expanded', 'false');
      }
    }
  }

  function closeMenu() {
    if (isMenuOpen) {
      toggleMenu();
    }
  }

  function updateNavBackground() {
    if (!nav) return;
    const scrollY = window && typeof window.scrollY === "number" ? window.scrollY : 0;
    if (scrollY > 50) {
      nav.classList.add("nav-scrolled");
    } else {
      nav.classList.remove("nav-scrolled");
    }
  }

  function handleScroll() {
    if (!nav) return;
    
    const currentScrollY = window.scrollY;

    // Determine scroll direction immediately
    if (currentScrollY > lastScrollY) {
      scrollDirection = "down";
    } else if (currentScrollY < lastScrollY) {
      scrollDirection = "up";
    }

    lastScrollY = currentScrollY;

    // Update background based on scroll position
    updateNavBackground();

    // Animate nav position based on scroll direction (only if menu is closed)
    if (!isMenuOpen) {
      if (navTween) navTween.kill();

      if (scrollDirection === "down") {
        // Slide up immediately when scrolling down
        navTween = gsap.to(nav, {
          y: -100,
          duration: 0.05,
          ease: "power1.inOut",
          overwrite: true,
        });
      } else {
        // Slide back down immediately when scrolling up
        navTween = gsap.to(nav, {
          y: 0,
          duration: 0.05,
          ease: "power1.inOut",
          overwrite: true,
        });
      }
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNavigation);
  } else {
    initNavigation();
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (typeof window !== "undefined") {
      window.removeEventListener("scroll", handleScroll);
    }
    if (navTween) navTween.kill();
  });
</script>

